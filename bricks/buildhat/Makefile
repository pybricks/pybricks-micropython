# SPDX-License-Identifier: MIT
# Copyright (c) 2025 The Pybricks Authors
#
# This is mostly a simple wrapper around cmake

PBIO_PLATFORM = build_hat

include ../../micropython/py/verbose.mk
include ../_common/sources.mk

BUILD = build

ifeq ($(BUILD_VERBOSE),1)
MAKE_ARGS += VERBOSE=1  # Picked up in Makefile generated by CMake
endif

# Pass lists of files so we don't have to maintain them in two places.
CMAKE_ARGS += -DPYBRICKS_PYBRICKS_SRC_C="$(subst $(eval ) ,;,$(PYBRICKS_PYBRICKS_SRC_C))"
CMAKE_ARGS += -DPYBRICKS_LIB_SRC_C="$(subst $(eval ) ,;,$(LWRB_SRC_C) $(PBIO_SRC_C) $(LEGO_SPEC_SRC_C))"

ifneq ($(FROZEN_MANIFEST),)
CMAKE_ARGS += -DMICROPY_FROZEN_MANIFEST=${FROZEN_MANIFEST}
endif

ifeq ($(DEBUG),1)
CMAKE_ARGS += -DCMAKE_BUILD_TYPE=Debug
endif

HELP_PICO_SDK_SUBMODULE ?= "\033[1;31mError: pico-sdk submodule is not initialized.\033[0m Run 'make submodules'"

all:
	$(Q)[ -f ../../micropython/lib/pico-sdk/README.md ] || (echo -e $(HELP_PICO_SDK_SUBMODULE); false)
	$(Q)cmake -S . -B $(BUILD) -DPICO_BUILD_DOCS=0 ${CMAKE_ARGS}
	$(Q)$(MAKE) $(MAKE_ARGS) -C $(BUILD)
# TODO: Make a zip file like other hubs?
	$(Q)zip -j $(BUILD)/firmware.zip $(BUILD)/firmware.bin

clean:
	$(RM) -rf $(BUILD)

# This is the default user and hostname for Raspberry Pi OS installs.
RPI_SSH ?= pi@raspberrypi

deploy: all
	$(Q)scp $(BUILD)/firmware.bin $(RPI_SSH):/tmp/pybricks-build-hat-firmware.bin
	$(Q)ssh $(RPI_SSH) -C python3 -m pybricks_build_hat.flash /tmp/pybricks-build-hat-firmware.bin

# First ensure that pico-sdk is initialised, then run CMake with the
# UPDATE_SUBMODULES flag to update necessary submodules for this board.
#
# This is done in a dedicated build directory as some CMake cache values are not
# set correctly if not all submodules are loaded yet.
submodules:
	$(Q)$(MAKE) -f ../../micropython/py/mkrules.mk GIT_SUBMODULES="lib/pico-sdk" submodules
	$(Q)cmake -S . -B $(BUILD)/submodules -DUPDATE_SUBMODULES=1 ${CMAKE_ARGS}

# Pybricks tools expect the firmware binary to be named firmware-base.bin.
$(BUILD)/firmware-base.bin: all
	$(Q)cp $(BUILD)/firmware.bin $@
